#########################################################
# Pulitura del nozzle
########################################################


[gcode_macro clean_nozzle_move]
description: Pulitura ugello
variable_move: True
gcode:
    
    {% if move == True %}
          {% set x = params.X %}
          {% set y = params.Y %}
          {% set z = params.Z %}
          G1 X{x} Y{y} Z{z}
    {% endif %}

[gcode_macro  _clean_nozzle_cooldown_check]
gcode:
  {% set extruder_temperature = printer[printer.toolhead.extruder].temperature %}
  {% set extruder_target = printer[printer.toolhead.extruder].target %}
  {% if extruder_temperature <= extruder_target %}
        SET_GCODE_VARIABLE MACRO=_clean_nozzle_move  VARIABLE=move VALUE=False
  {% endif %}

    ###############################################################################################################################################
# La macro CLEAN_HOTCOLD è progettata per eseguire una pulizia avanzata dell'ugello, utilizzando una combinazione di fasi a caldo e a freddo. 
# La macro CLEAN_HOTCOLD esegue una pulizia completa dell'ugello, iniziando a una temperatura elevata e raffreddandolo progressivamente. 
# Durante questa operazione, vengono eseguite numerose passate di pulizia, con la ventola di raffreddamento attivata al massimo per facilitare 
# il raffreddamento dell'ugello. Al termine della pulizia, la macro ripristina lo stato originale della stampante, incluso l'offset Z.
###############################################################################################################################################

[gcode_macro CLEAN_HOTCOLD]
Description: Pulizia avanzata dell'ugello
variable_temperature_offset:   30  ;Questa variabile definisce un offset di temperatura di 30 gradi 
# che verrà sottratto dalla temperatura target dell'estrusore durante la fase di raffreddamento.
gcode:
    {% set extruder_target = printer[printer.toolhead.extruder].target %} ; Temperatura target attuale dell'estrusore.
    {% set extruder_temperature = printer[printer.toolhead.extruder].temperature %} ; Temperatura attuale dell'estrusore.
    {% set cooltemp_target = extruder_target - temperature_offset %} ;  Temperatura target ridotta di 30°C (grazie al temperature_offset).
    {% set min_extrude_temp = printer.configfile.settings.extruder.min_extrude_temp %} ; Temperatura minima di estrusione configurata per l'estrusore.
    {% if extruder_target >= min_extrude_temp and extruder_temperature >= min_extrude_temp %} ; Verifica che la temperatura target e la temperatura attuale dell'estrusore siano 
    # entrambe maggiori o uguali alla temperatura minima di estrusione.
        SAVE_GCODE_STATE NAME=STATE_CLEAN                                             ; Salva lo stato corrente della stampante per poterlo ripristinare dopo la pulizia.
        SET_GCODE_OFFSET Z=0.0                                                        ; Resetta l'offset Z del G-code, riportandolo a zero. Può essere utile se l'offset è stato modificato per altre operazioni.
        SET_GCODE_VARIABLE MACRO=clean_nozzle  VARIABLE=wipe_qty VALUE=100            ; Imposta un numero elevato di passaggi di pulizia (100) per dare tempo all'ugello di raffreddarsi.
        SET_GCODE_VARIABLE MACRO=clean_nozzle  VARIABLE=enable_purge VALUE=False      ;  Disabilita la purga del filamento durante questa operazione.
        SET_GCODE_VARIABLE MACRO=clean_nozzle  VARIABLE=enable_hotcold VALUE=True     ; Abilita la funzione di pulizia a caldo e a freddo.
        M109 S{extruder_target}                                                       ; attendere che l'estrusore raggiunga la temperatura target
        M104 S{cooltemp_target}                                                       ; Imposta una nuova temperatura target più bassa per raffreddare l'ugello durante i passaggi di pulizia.
        M106 S256                                                                     ; impostare la velocità della ventola al massimo per favorire il raffreddamento
        G4 P{10 * 1000}                                                               ; Introduce un'attesa (G4) di 10 secondi per permettere all'ugello di stabilizzarsi prima della pulizia.
        CLEAN_NOZZLE                                                                  ; Avvia il processo di pulizia con la macro CLEAN_NOZZLE, precedentemente configurata con le variabili.
        M106 S0                                                                       ; Spegne la ventola di raffreddamento.
        SET_GCODE_VARIABLE MACRO=clean_nozzle  VARIABLE=enable_hotcold VALUE=False    ; Disabilita la modalità di pulizia a caldo e freddo nella macro clean_nozzle.
        RESTORE_GCODE_STATE NAME=STATE_CLEAN                                          ; Ripristina lo stato della stampante salvato all'inizio della macro.
    {% endif %}

    ###############################################################################################################################################
# La macro CLEAN_PURGE è un comando G-code che esegue una pulizia dell'ugello della stampante 3D e include una fase di purga, cioè un'estrusione
#forzata di filamento per rimuovere eventuali residui dall'interno dell'ugello. Di seguito è spiegato come funziona il comando e come utilizzarlo.
###############################################################################################################################################


[gcode_macro CLEAN_PURGE]
Description: Pulizia dell'ugello che include una fase di purga, cioè un'estrusione forzata di 50 mm del filamento per rimuovere eventuali residui dall'interno dell'ugello. 
gcode:
    SAVE_GCODE_STATE NAME=STATE_CLEAN ; Salva lo stato corrente della stampante, inclusa la posizione degli assi, le temperature e altre variabili, così da poterle ripristinare dopo la pulizia.
    SET_GCODE_OFFSET Z=0.0  ;Resetta l'offset dell'asse Z a zero, per garantire che il movimento durante la pulizia non sia influenzato da eventuali modifiche precedenti all'offset Z.
    SET_GCODE_VARIABLE MACRO=clean_nozzle  VARIABLE=wipe_qty VALUE=5 ;Imposta la quantità di passaggi di pulizia (wipes) a 5. Durante questi passaggi, l'ugello verrà pulito su una superficie dedicata.
    SET_GCODE_VARIABLE MACRO=clean_nozzle  VARIABLE=enable_purge VALUE=True ; Abilita la purga del filamento. Questo significa che durante la pulizia, verrà estruso filamento per eliminare eventuali residui interni all'ugello.
    SET_GCODE_VARIABLE MACRO=clean_nozzle  VARIABLE=purge_len VALUE=50 ;Imposta la lunghezza della purga del filamento a 100 mm. 
    #Questo significa che verrà estruso un breve tratto di filamento, sufficiente per preparare l'ugello senza sprecare troppo materiale.
    CLEAN_NOZZLE ; Avvia la procedura di pulizia e purga dell'ugello utilizzando le impostazioni precedentemente definite.
    RESTORE_GCODE_STATE NAME=STATE_CLEAN ;  Ripristina lo stato della stampante al termine della pulizia, riportando la macchina alle condizioni in cui si trovava prima di eseguire il comando.

###############################################################################################################################################
# La macro CLEAN_PRIME è progettata per eseguire una rapida pulizia e preparazione dell'ugello della stampante 3D, con l'aggiunta di una piccola
#purga (priming) del filamento per garantire che l'ugello sia pronto per la stampa. Ecco una descrizione dettagliata e come utilizzare questo comando.
###############################################################################################################################################

[gcode_macro CLEAN_PRIME]
Description: Pulizia dell'ugello che include una fase di purga, cioè un'estrusione forzata di 25mm del filamento per rimuovere eventuali residui dall'interno dell'ugello. 
gcode:
    SAVE_GCODE_STATE NAME=STATE_CLEAN ; Salva lo stato corrente della stampante, inclusa la posizione degli assi, le temperature e altre variabili, così da poterle ripristinare dopo la pulizia.
    SET_GCODE_OFFSET Z=0.0   ;Resetta l'offset dell'asse Z a zero, per garantire che il movimento durante la pulizia non sia influenzato da eventuali modifiche precedenti all'offset Z.
    SET_GCODE_VARIABLE MACRO=clean_nozzle  VARIABLE=wipe_qty VALUE=5 ;Imposta la quantità di passaggi di pulizia (wipes) a 5. Durante questi passaggi, l'ugello verrà pulito su una superficie dedicata.
    SET_GCODE_VARIABLE MACRO=clean_nozzle  VARIABLE=enable_purge VALUE=True ;Abilita la purga del filamento. Questo significa che durante la pulizia, verrà estruso filamento per eliminare eventuali residui interni all'ugello.
    SET_GCODE_VARIABLE MACRO=clean_nozzle  VARIABLE=purge_len VALUE=25 ;Imposta la lunghezza della purga del filamento a 25 mm. 
    #Questo significa che verrà estruso un breve tratto di filamento, sufficiente per preparare l'ugello senza sprecare troppo materiale.
    CLEAN_NOZZLE  ; Avvia la procedura di pulizia e purga dell'ugello utilizzando le impostazioni precedentemente definite.
    RESTORE_GCODE_STATE NAME=STATE_CLEAN ;  Ripristina lo stato della stampante al termine della pulizia, riportando la macchina alle condizioni in cui si trovava prima di eseguire il comando.

###############################################################################################################################################
#macro CLEAN_NOPURGE è un comando G-code che esegue una pulizia dell'ugello della stampante 3D senza effettuare la purga del filamento. 
# Questo comando è utile per rimuovere eventuali residui esterni dall'ugello senza sprecare filamento tramite estrusione.
###############################################################################################################################################

[gcode_macro CLEAN_NOPURGE]
Description: Pulizia dell'ugello senza un'estrusione del filamento.
gcode:
    SAVE_GCODE_STATE NAME=STATE_CLEAN ; Salva lo stato corrente della stampante, inclusa la posizione degli assi, le temperature e altre variabili, così da poterle ripristinare dopo la pulizia.
    SET_GCODE_OFFSET Z=0.0   ;Resetta l'offset dell'asse Z a zero, per garantire che il movimento durante la pulizia non sia influenzato da eventuali modifiche precedenti all'offset Z.
    SET_GCODE_VARIABLE MACRO=clean_nozzle  VARIABLE=wipe_qty VALUE=3 ;Imposta la quantità di passaggi di pulizia (wipes) a 5. Durante questi passaggi, l'ugello verrà pulito su una superficie dedicata.
    SET_GCODE_VARIABLE MACRO=clean_nozzle  VARIABLE=enable_purge VALUE=False ; Disabilita la purga del filamento durante la pulizia, evitando l'estrusione di materiale.
    CLEAN_NOZZLE  ; Avvia la procedura di pulizia dell'ugello utilizzando i parametri definiti (3 passaggi di pulizia, senza purga).
    RESTORE_GCODE_STATE NAME=STATE_CLEAN ; Ripristina lo stato della stampante al termine della pulizia, riportando la macchina alle condizioni originali.
